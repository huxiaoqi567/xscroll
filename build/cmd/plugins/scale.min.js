define(function(e,n,i){var a=e("../util"),t=e("../base"),r=(e("../animate"),300),l=function(e){l.superclass.constructor.call(this,e),this.userConfig=a.mix({minScale:1,maxScale:2,duration:r},e)};if(a.extend(l,t,{pluginId:"scale",pluginInitializer:function(e){var n=this;return n.scale=1,n.xscroll=e.render(),n.initialContainerWidth=e.containerWidth,n.initialContainerHeight=e.containerHeight,n.minScale=n.userConfig.minScale||Math.max(e.width/e.containerWidth,e.height/e.containerHeight),n.maxScale=n.userConfig.maxScale||1,n._bindEvt(),n},pluginDestructor:function(){var e=this,n=e.xscroll;return n.off("doubletap",e._doubleTapHandler,e),n.off("pinchstart",e._pinchStartHandler,e),n.off("pinch",e._pinchHandler,e),n.off("pinchend",e._pinchEndHandler,e),e},_doubleTapHandler:function(e){var n=this,i=n.xscroll,a=n.userConfig.minScale,t=n.userConfig.maxScale;return n.originX=(e.center.x-i.x)/i.containerWidth,n.originY=(e.center.y-i.y)/i.containerHeight,i.scale>n.minScale?n.scaleTo(a,n.originX,n.originY,200):n.scaleTo(t,n.originX,n.originY,200),n},_pinchStartHandler:function(e){var n=this,i=n.xscroll;i.mc.get("pan").set({enable:!1}),i.stop(),n.isScaling=!1,n.scale=i.scale,n.originX=(e.center.x-i.x)/i.containerWidth,n.originY=(e.center.y-i.y)/i.containerHeight},_pinchHandler:function(e){var n=this,i=n.scale,a=n.xscroll,t=n.originX,r=n.originY,l=i*e.scale;l<=n.userConfig.minScale&&(l=.5*n.userConfig.minScale*Math.pow(2,l/n.userConfig.minScale)),l>=n.userConfig.maxScale&&(l=2*n.userConfig.maxScale*Math.pow(.5,n.userConfig.maxScale/l)),n._scale(l,t,r),n.xscroll.translate(a.x,a.y,l)},_pinchEndHandler:function(){var e=this,n=e.originX,i=e.originY,a=e.xscroll;a.scale<e.minScale?e.scaleTo(e.minScale,n,i,r,"ease-out"):a.scale>e.maxScale?e.scaleTo(e.maxScale,n,i,r,"ease-out"):a.mc.get("pan").set({enable:!0})},_bindEvt:function(){var e=this,n=e.xscroll;return n.on("doubletap",e._doubleTapHandler,e),n.on("pinchstart",e._pinchStartHandler,e),n.on("pinch",e._pinchHandler,e),n.on("pinchend",e._pinchEndHandler,e),e},_scale:function(e,n,i){var a=this,t=a.xscroll,r=a.xscroll.boundry;if(t.scale!=e&&e){a.isScaling||(a.scaleBegin=t.scale,a.isScaling=!0,a.scaleBeginX=t.x,a.scaleBeginY=t.y),n&&(a.originX=n),i&&(a.originY=i);var l=e*a.initialContainerWidth,c=e*a.initialContainerHeight;t.containerWidth=Math.round(l>t.width?l:t.width),t.containerHeight=Math.round(c>t.height?c:t.height),t.scale=e;var o=n*(a.initialContainerWidth*a.scaleBegin-t.containerWidth)+a.scaleBeginX,s=i*(a.initialContainerHeight*a.scaleBegin-t.containerHeight)+a.scaleBeginY;o>r.left&&(o=r.left),s>r.top&&(s=r.top),o<r.right-t.containerWidth&&(o=r.right-t.containerWidth),s<r.bottom-t.containerHeight&&(s=r.bottom-t.containerHeight),t.x=o,t.y=s}},scaleTo:function(e,n,i,a,t,l){var c=this,o=c.xscroll;if(o.scale!=e&&e){var a=a||r,t=t||"ease-out";c._scale(e,n,i),o._animate("x","translateX("+o.x+"px) scale("+e+")",a,t,l),o._animate("y","translateY("+o.y+"px)",a,t,l),c.scaleHandler=c.scaleHandler||function(a){var t=(e-scaleStart)*a.percent+scaleStart;c.trigger("scale",{scale:t,origin:{x:n,y:i}})},c.scaleendHandler=c.scaleendHandler||function(){c.isScaling=!1,o.mc.get("pan").set({enable:!0}),c.trigger("scaleend",{type:"scaleend",scale:c.scale,origin:{x:n,y:i}})},o.__timers.x.timer.off("run",c._scaleHandler,c),o.__timers.x.timer.on("run",c._scaleHandler,c),o.__timers.x.timer.off("stop",c.scaleendHandler,c),o.__timers.x.timer.on("stop",c.scaleendHandler,c),c.trigger("scaleanimate",{scale:o.scale,duration:a,easing:t,offset:{x:o.x,y:o.y},origin:{x:n,y:i}})}}}),"object"==typeof i&&i.exports)i.exports=l;else if(window.XScroll&&window.XScroll.Plugins)return XScroll.Plugins.Scale=l});